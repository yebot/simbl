name: SIMBL Quick Add

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Task title'
        required: true
        type: string
      priority:
        description: 'Priority (p1-p9, optional)'
        required: false
        type: string
      project:
        description: 'Project name (optional)'
        required: false
        type: string
      content:
        description: 'Task description (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  add-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Add task to SIMBL
        run: |
          TASKS_FILE=".simbl/tasks.md"

          # Check if tasks file exists
          if [ ! -f "$TASKS_FILE" ]; then
            echo "Error: $TASKS_FILE not found"
            exit 1
          fi

          # Get prefix from config or derive from existing tasks
          PREFIX="task"
          if [ -f ".simbl/config.yaml" ]; then
            CONFIG_PREFIX=$(grep "^prefix:" .simbl/config.yaml | sed 's/prefix: *//' | tr -d '"' | tr -d "'")
            if [ -n "$CONFIG_PREFIX" ]; then
              PREFIX="$CONFIG_PREFIX"
            fi
          fi

          # Find highest existing task ID
          HIGHEST_NUM=$(grep -oE "^## ${PREFIX}-[0-9]+" "$TASKS_FILE" | grep -oE "[0-9]+$" | sort -n | tail -1)
          if [ -z "$HIGHEST_NUM" ]; then
            HIGHEST_NUM=0
          fi
          NEXT_NUM=$((HIGHEST_NUM + 1))
          TASK_ID="${PREFIX}-${NEXT_NUM}"

          # Build tags line
          TAGS=""
          if [ -n "${{ inputs.priority }}" ]; then
            TAGS="${TAGS}[${{ inputs.priority }}]"
          fi
          if [ -n "${{ inputs.project }}" ]; then
            TAGS="${TAGS}[project:${{ inputs.project }}]"
          fi
          TAGS="${TAGS}[mobile-capture]"

          # Build task content
          TASK_BLOCK="## ${TASK_ID} ${{ inputs.title }}

${TAGS}
"
          if [ -n "${{ inputs.content }}" ]; then
            TASK_BLOCK="${TASK_BLOCK}
### Description

${{ inputs.content }}
"
          fi

          # Find the line number of "# Backlog" and insert after it
          BACKLOG_LINE=$(grep -n "^# Backlog" "$TASKS_FILE" | head -1 | cut -d: -f1)
          if [ -z "$BACKLOG_LINE" ]; then
            echo "Error: Could not find '# Backlog' section in $TASKS_FILE"
            exit 1
          fi

          # Insert the task after the Backlog header (with a blank line)
          {
            head -n "$BACKLOG_LINE" "$TASKS_FILE"
            echo ""
            echo "$TASK_BLOCK"
            tail -n +"$((BACKLOG_LINE + 1))" "$TASKS_FILE"
          } > "${TASKS_FILE}.tmp"
          mv "${TASKS_FILE}.tmp" "$TASKS_FILE"

          echo "Added task: $TASK_ID - ${{ inputs.title }}"
          echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV

      - name: Commit and push
        run: |
          git add .simbl/tasks.md
          git commit -m "Add task ${{ env.TASK_ID }}: ${{ inputs.title }}

Added via GitHub Actions workflow_dispatch (mobile capture)
"
          git push origin ${{ github.ref_name }}

      - name: Summary
        run: |
          echo "## Task Added Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Task ID:** ${{ env.TASK_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ inputs.title }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.priority }}" ]; then
            echo "**Priority:** ${{ inputs.priority }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.project }}" ]; then
            echo "**Project:** ${{ inputs.project }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull the latest changes to see the new task in your local backlog." >> $GITHUB_STEP_SUMMARY
